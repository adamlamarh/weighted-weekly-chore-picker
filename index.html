<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Weighted Weekly Chore Picker</title><meta name="color-scheme" content="light dark">
<style>
:root{--bg:#0b0c10;--text:#111827;--muted:#6b7280;--card:#fff;--accent:#2563eb;--accent2:#10b981;--border:#e5e7eb;color-scheme:light dark}
@media (prefers-color-scheme:dark){:root{--bg:#0b0c10;--text:#f3f4f6;--muted:#9ca3af;--card:#111827;--accent:#60a5fa;--accent2:#34d399;--border:#1f2937}}
*{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
.container{max-width:1100px;margin:0 auto;padding:24px}header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
h1{font-size:clamp(20px,4vw,28px);margin:0}.sub{color:var(--muted);font-size:14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
.controls,.row{display:flex;flex-wrap:wrap;gap:12px;align-items:end}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input[type=number],input[type=text]{background:transparent;color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:10px;min-width:140px}
input[type=text]{min-width:220px}
.btn{appearance:none;border:1px solid var(--border);background:var(--text);color:var(--bg);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
.btn.secondary{background:transparent;color:var(--text)}.btn.accent{background:var(--accent);color:#fff;border-color:transparent}.btn.success{background:var(--accent2);color:#06261b;border-color:transparent}
.pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);background:transparent;border:1px solid var(--border);padding:4px 10px;border-radius:999px}
.section-title{display:flex;align-items:center;justify-content:space-between;margin:16px 0 8px}
.progress{height:10px;width:100%;background:transparent;border:1px solid var(--border);border-radius:999px;overflow:hidden}.progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;transition:width .3s ease}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}.task-card{position:relative;border:1px solid var(--border);background:var(--card);border-radius:14px;padding:14px 16px}
.task-title{font-weight:700;margin:0 0 6px;font-size:16px}.muted{color:var(--muted);font-size:12px}.badges{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.table{width:100%;border-collapse:collapse}.table th,.table td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:1000}
.overlay.show{display:flex}.draw-modal{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;width:min(720px,94vw);box-shadow:0 30px 60px rgba(0,0,0,.25)}
.draw-item{position:relative;border:1px solid var(--border);background:var(--card);border-radius:14px;padding:14px 16px;box-shadow:0 14px 28px rgba(0,0,0,.08);margin:8px 0}
.roller{font-weight:800;letter-spacing:.2px;font-size:18px;line-height:1.35;opacity:.85;animation:pulse 1s ease-in-out infinite}.roller.final{animation:none}
@keyframes pulse{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}@keyframes pop{0%{transform:scale(.92);opacity:.2}70%{transform:scale(1.03);opacity:1}100%{transform:scale(1)}}
.confetti{position:absolute;width:8px;height:12px;border-radius:2px;top:8px;left:50%;transform:translateX(-50%);opacity:.95;animation:conf 1.6s ease-out forwards}
@keyframes conf{0%{transform:translate(-50%,-10px) rotate(0deg);opacity:1}100%{transform:translate(calc(-50% + var(--dx,0px)),140px) rotate(300deg);opacity:0}}
.owner-line{display:flex;align-items:center;gap:8px;margin-top:8px}.owner-badge{font-size:12px;padding:4px 8px;border-radius:8px;background:rgba(16,185,129,.14);color:#10b981;font-weight:800}
</style></head>
<body>
<div class="container">
  <header>
    <div><h1>Weighted Weekly Chore Picker</h1><div class="sub">Monthly pool • No repeats • Weekly cap • Two-person fairness</div></div>
    <div style="display:flex;gap:8px;align-items:center"><div class="pill" id="monthPill">Month: —</div></div>
  </header>

  <section class="card">
    <div class="controls">
      <div><label for="cap">Weekly weight cap</label><input id="cap" type="number" step="0.5" min="0.5" value="8"></div>
      <div><label>People (comma separated)</label><input id="people" type="text" placeholder="Adam, Hannah" value="Adam, Hannah"></div>
      <button class="btn accent" id="drawBtn">Draw this week</button>
      <button class="btn success" id="finishBtn" title="Pick all remaining items for this month">Finish month</button>
      <button class="btn secondary" id="undoBtn" title="Undo last week">Undo last week</button>
      <button class="btn secondary" id="resetBtn" title="Start new month">Reset month</button>
    </div>

    <div class="section-title" style="margin-top:14px"><strong>This month</strong> <span class="muted" id="monthStats">—</span></div>
    <div class="progress"><span id="progressBar"></span></div>

    <div class="section-title" style="margin-top:16px"><strong>Last draw</strong> <span class="muted" id="lastDrawMeta">—</span></div>
    <div class="grid" id="lastDraw"></div>
  </section>

  <section class="section-title" style="margin-top:16px"><strong>Remaining tasks this month</strong> <span class="muted" id="remainingMeta">—</span></section>
  <div class="grid" id="remaining"></div>

  <section class="section-title" style="margin-top:16px"><strong>Manage chores</strong><span class="muted">Changes save locally</span></section>
  <div class="card">
    <div class="row">
      <input id="newName" type="text" placeholder="Chore name">
      <input id="newWeight" type="number" step="0.5" placeholder="Weight">
      <input id="newTags" type="text" placeholder="Tags (comma separated)">
      <button class="btn" id="addBtn">Add chore</button>
      <button class="btn secondary" id="exportBtn">Export JSON</button>
      <input type="file" id="importInput" accept="application/json" style="display:none">
      <button class="btn secondary" id="importBtn">Import JSON</button>
    </div>
    <div style="overflow:auto;margin-top:12px">
      <table class="table" id="table"><thead><tr><th>Name</th><th style="width:120px">Weight</th><th>Tags</th><th style="width:80px"></th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<!-- Draw overlay -->
<div id="drawOverlay" class="overlay" aria-hidden="true"><div class="draw-modal" role="dialog" aria-modal="true" aria-labelledby="drawTitle">
  <div style="display:flex;align-items:baseline;justify-content:space-between;gap:8px;margin-bottom:10px"><h2 id="drawTitle" class="task-title" style="margin:0;font-size:20px">Weekly Draw</h2><div id="drawMeta" class="muted">—</div></div>
  <div id="drawList"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button class="btn secondary" id="skipDraw">Skip animation</button></div>
</div></div>

<script>
(function(){
  const monthKey=()=>new Date().toISOString().slice(0,7);
  const LS_DATA='choresDeck_v1_data';
  const LS_STATE='choresDeck_v1_state';
  const WEEK_TOL=0.5; // weekly fairness tolerance (±0.5)

  const defaultChores=[
    {id:'cleaning_shared_bathroom',name:'Cleaning Shared Bathroom',weight:3,tags:['Bathroom']},
    {id:'cleaning_bedroom_bathroom',name:'Cleaning Bedroom Bathroom',weight:3,tags:['Bathroom']},
    {id:'cleaning_base_floor_bathroom',name:'Cleaning Base Floor Bathroom',weight:3,tags:['Bathroom']},
    {id:'sweeping_main_level_floor',name:'Sweeping the main level floor',weight:1,tags:['Floors']},
    {id:'sweeping_second_level_floor',name:'Sweeping the second level floor',weight:1,tags:['Floors']},
    {id:'mopping_main_level_floor',name:'Mopping the main level floor',weight:2,tags:['Floors']},
    {id:'mopping_second_level_floor',name:'Mopping the second level floor',weight:2,tags:['Floors']},
    {id:'metsi_nails',name:'Metsi Nails',weight:1,tags:['Pet']},
    {id:'metsi_bath',name:'Metsi Bath',weight:1.5,tags:['Pet']},
    {id:'inspecting_the_attic',name:'Inspecting the attic',weight:2.5,tags:['Home Care']},
    {id:'weeding',name:'Weeding',weight:2,tags:['Outdoor']},
    {id:'lawn_mowing_weed_wacking',name:'Lawn Mowing/Weed Wacking',weight:3,tags:['Outdoor']},
    {id:'watering_the_plants',name:'Watering the plants',weight:1,tags:['Outdoor']},
    {id:'cleaning_organizing_the_fridge',name:'Cleaning/Organizing the Fridge',weight:2,tags:['Kitchen']},
    {id:'dusting_the_main_floor',name:'Dusting the main floor',weight:1.5,tags:['Dusting']},
    {id:'dusting_the_second_floor',name:'Dusting the second floor',weight:1.5,tags:['Dusting']},
    {id:'wiping_down_windows_main_floor',name:'Wiping Down Windows main floor',weight:2,tags:['Windows']},
    {id:'wiping_down_windows_second_floor',name:'Wiping Down Windows second floor',weight:2,tags:['Windows']},
    {id:'tidying_main_floor',name:'General Item Cleanup/Tidying Main Floor',weight:1,tags:['Tidy']},
    {id:'tidying_second_floor',name:'General Item Cleanup/Tidying Second Floor',weight:1,tags:['Tidy']},
    {id:'wiping_down_walls',name:'Wiping Down Walls',weight:2,tags:['Surfaces']},
    {id:'vacuuming_stairs_living_room',name:'Vacuuming Stairs/Living Room',weight:2,tags:['Floors']},
    {id:'vaccuuming_upstairs',name:'Vaccuuming Upstairs',weight:1.5,tags:['Floors']}
  ];

  let chores=load(LS_DATA)||defaultChores; let state=load(LS_STATE)||{}; ensureMonthState();
  const $=q=>document.querySelector(q);
  const capInput=$('#cap'), peopleInput=$('#people'), monthPill=$('#monthPill'), monthStats=$('#monthStats'), progressBar=$('#progressBar');
  const lastDrawEl=$('#lastDraw'), lastDrawMeta=$('#lastDrawMeta'), remainingEl=$('#remaining'), remainingMeta=$('#remainingMeta');
  const tableBody=$('#table tbody');

  // Wire up controls
  $('#drawBtn').addEventListener('click', onDrawWeek);
  $('#finishBtn').addEventListener('click', ()=>acceptDraw(remainingPool(),true));
  $('#undoBtn').addEventListener('click', undoLastWeek);
  $('#resetBtn').addEventListener('click', resetMonthConfirm);
  $('#exportBtn').addEventListener('click', exportJSON);
  $('#importBtn').addEventListener('click', ()=>$('#importInput').click());
  $('#importInput').addEventListener('change', importJSON);
  $('#addBtn').addEventListener('click', addChore);

  capInput.value=(state.cap==null?8:state.cap); peopleInput.value=(state.people&&state.people.length)?state.people.join(', '):'Adam, Hannah';
  renderAll();

  // ==== Actions ====
  function onDrawWeek(){
    const cap=getCap(); const pool=remainingPool();
    if(pool.length===0){ alert('No remaining tasks this month. Use Reset month to start a new month.'); return; }
    const picked=pickWeeklySet(pool,cap,readPeople());
    if(picked.length===0){ const lightest=[...pool].sort((a,b)=>a.weight-b.weight)[0]; if(lightest) picked.push(lightest); }
    const assigned=fairAssign(picked,readPeople());
    animateDraw(assigned).then(()=>acceptDraw(assigned,false));
  }
  function acceptDraw(items,isFinish){
    const m=monthKey(); const people=readPeople(); const hasOwners=items.every(i=>i.owner); const assigned=hasOwners?items:fairAssign(items,people);
    const total=items.reduce((s,t)=>s+(t.weight||0),0);
    state[m].history.push({ts:Date.now(),items:assigned,total,finish:!!isFinish});
    const used=new Set(state[m].used); items.forEach(i=>used.add(i.id)); state[m].used=[...used];
    state.cap=getCap(); state.people=people; save(LS_STATE,state); renderAll();
  }
  function undoLastWeek(){ const m=monthKey(); const h=state[m].history; if(!h.length){alert('Nothing to undo.');return;} const last=h.pop(); const ids=new Set(last.items.map(x=>x.id)); state[m].used=state[m].used.filter(id=>!ids.has(id)); save(LS_STATE,state); renderAll(); }
  function resetMonthConfirm(){ if(confirm("Start a fresh month now? This clears this month's draws.")){ const m=monthKey(); state[m]={used:[],history:[]}; save(LS_STATE,state); renderAll(); } }

  // ==== Export / Import ====
  function exportJSON(){
    try{
      const payload={version:1, chores:chores};
      const data=JSON.stringify(payload,null,2);
      const blob=new Blob([data],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='chores-'+monthKey()+'.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }catch(err){ console.error('Export failed:',err); alert('Export failed: '+(err&&err.message||err)); }
  }
  async function importJSON(e){
    const file=(e&&e.target&&e.target.files&&e.target.files[0])||null; if(!file) return;
    try{
      const text=await file.text();
      const json=JSON.parse(text);
      const src=Array.isArray(json)?json:(Array.isArray(json.chores)?json.chores:null);
      if(!src) throw new Error('JSON must be an array of chores or {"chores": [...]}');
      const seen=new Set(); const cleaned=[];
      for(const c of src){ if(!c) continue; const name=String(c.name||'').trim(); let weight=parseFloat(c.weight); if(!name||isNaN(weight)||weight<=0) continue; const id=slug(c.id||name); if(seen.has(id)) continue; seen.add(id); const tags=Array.isArray(c.tags)?c.tags.filter(Boolean):[]; cleaned.push({id,name,weight:Math.max(0.5,weight),tags}); }
      if(!cleaned.length) throw new Error('No valid chores found.');
      chores=cleaned; save(LS_DATA,chores);
      // Keep current month but drop used items no longer present
      ensureMonthState(); const m=monthKey(); state[m].used=(state[m].used||[]).filter(id=>chores.some(c=>c.id===id)); save(LS_STATE,state);
      renderAll();
      alert('Imported '+cleaned.length+' chores.');
    }catch(err){ console.error('Import failed:',err); alert('Import failed: '+(err&&err.message||err)); }
    finally{ if(e&&e.target) e.target.value=''; }
  }

  // ==== Core helpers ====
  function ensureMonthState(){ const m=monthKey(); if(!state[m]) state[m]={used:[],history:[]}; const keys=Object.keys(state).filter(k=>k.length===7&&k[4]==='-'&&isYearMonth(k)); keys.sort(); while(keys.length>6){ delete state[keys.shift()]; } save(LS_STATE,state); }
  function isYearMonth(k){ const y=k.slice(0,4), mm=k.slice(5,7); const yi=+y, mi=+mm; return !isNaN(yi) && !isNaN(mi) && mi>=1 && mi<=12; }
  function remainingPool(){ const m=monthKey(); const used=new Set(state[m].used); return chores.filter(c=>!used.has(c.id)); }
  function getCap(){ const v=parseFloat(capInput.value); return Math.max(0.5, isNaN(v)?8:v); }
  function readPeople(){ return peopleInput.value.split(',').map(s=>s.trim()).filter(Boolean); }

  function pickWeeklySet(pool,cap,people){ return (people.length===2)? optimizeWeeklySubset2(pool,cap,people) : drawToCapRandom(pool,cap); }
  function drawToCapRandom(pool,cap){ const remaining=pool.slice(); const picked=[]; let total=0; let guard=1000; while(guard--&&remaining.length){ const feasible=remaining.filter(t=> total+(t.weight||0) <= cap); if(!feasible.length) break; const chosen=weightedPick(feasible); picked.push(chosen); total+=(chosen.weight||0); const idx=remaining.findIndex(x=>x.id===chosen.id); if(idx>-1) remaining.splice(idx,1);} return picked; }
  function weightedPick(list){ const tot=list.reduce((s,t)=>s+(t.weight||1),0); let r=Math.random()*tot; for(const it of list){ r-= (it.weight||1); if(r<=0) return it; } return list[list.length-1]; }

  // Optimizer to honor ±0.5 weekly fairness where feasible, then maximize cap usage, then improve month balance
  function optimizeWeeklySubset2(pool,cap,people){
    const A=people[0], B=people[1]; const capU=Math.max(1,Math.floor(cap*2));
    const mt=getMonthTotals(people); const mA=mt.get(A)||0, mB=mt.get(B)||0; const T=Math.round(WEEK_TOL*2);
    const items=pool.map((it,idx)=>({it,idx,wU:Math.max(1,Math.round((it.weight||0)*2))})).filter(x=>x.wU<=capU);
    let best=null;
    function better(a,b){ if(!a) return true; if(a.hasTol!==b.hasTol) return b.hasTol; if(a.capGap!==b.capGap) return b.capGap<a.capGap; if(Math.abs(a.monthDelta-b.monthDelta)>1e-9) return b.monthDelta<a.monthDelta; if(a.weekDiffU!==b.weekDiffU) return b.weekDiffU<a.weekDiffU; if(a.sumU!==b.sumU) return b.sumU>a.sumU; return false; }
    function evalSubset(sumU,dp,mask){ if(sumU===0) return; const sumW=sumU/2; let local=null; for(let sU=0;sU<=sumU;sU++){ if(!(((dp>>sU)&1)===1)) continue; const weekDiffU=Math.abs(sumU-2*sU); const s=sU/2; const monthDelta=Math.abs((mA+s)-(mB+(sumW-s))); const cand={hasTol:weekDiffU<=T,weekDiffU,monthDelta,capGap:(capU-sumU),sumU,mask}; if(!local||cand.monthDelta<local.monthDelta-1e-9||(Math.abs(cand.monthDelta-local.monthDelta)<=1e-9&&cand.weekDiffU<local.weekDiffU-1e-9)) local=cand; } if(better(best,local)) best=local; }
    function dfs(i,sumU,dp,mask){ if(sumU>capU) return; if(mask) evalSubset(sumU,dp,mask); if(i>=items.length) return; const wU=items[i].wU; dfs(i+1,sumU+wU,(dp<<wU)|dp,mask|(1<<i)); dfs(i+1,sumU,dp,mask); }
    dfs(0,0,1,0); if(!best){ return drawToCapRandom(pool,cap); }
    const out=[]; for(let i=0;i<items.length;i++){ if((best.mask&(1<<i))!==0) out.push(items[i].it); } return out;
  }

  function getMonthTotals(people){ const m=monthKey(); const totals=new Map(); people.forEach(p=>totals.set(p,0)); const hist=state[m].history||[]; for(const h of hist){ for(const it of h.items){ if(it.owner && totals.has(it.owner)){ totals.set(it.owner,(totals.get(it.owner)||0)+(it.weight||0)); } } } return totals; }

  function fairAssign(items,people){
    if(!people.length) return items.map(i=>({ ...i, owner: undefined })); if(people.length===1) return items.map(i=>({ ...i, owner: people[0] }));
    if(people.length===2){ const A=people[0], B=people[1]; const mt=getMonthTotals(people); const mA=mt.get(A)||0, mB=mt.get(B)||0; const weights=items.map(i=>i.weight||0); const W=weights.reduce((s,w)=>s+w,0); const n=items.length; if(n<=26){ let bestMask=0; let best={hasTol:false,weekDiff:1e9,monthDelta:1e9,targetDiff:1e9}; const target=(W-(mA-mB))/2; for(let mask=0; mask<(1<<n); mask++){ let s=0; for(let i=0;i<n;i++){ if((mask&(1<<i))!==0) s+=weights[i]; } const weekDiff=Math.abs(W-2*s); const hasTol=weekDiff<=WEEK_TOL+1e-9; const monthDelta=Math.abs((mA+s)-(mB+(W-s))); const tdiff=Math.abs(target-s); const cand={hasTol,weekDiff,monthDelta,targetDiff:tdiff}; const better=(cand.hasTol&&!best.hasTol)||(cand.hasTol===best.hasTol&&cand.monthDelta<best.monthDelta-1e-9)||(cand.hasTol===best.hasTol&&Math.abs(cand.monthDelta-best.monthDelta)<=1e-9&&cand.weekDiff<best.weekDiff-1e-9)||(cand.hasTol===best.hasTol&&Math.abs(cand.monthDelta-best.monthDelta)<=1e-9&&Math.abs(cand.weekDiff-best.weekDiff)<=1e-9&&cand.targetDiff<best.targetDiff-1e-9); if(better){best=cand; bestMask=mask;} } return items.map((it,i)=>({ ...it, owner: ((bestMask&(1<<i))!==0)?A:B })); }
      const totals=new Map([[A,mA],[B,mB]]); const weekTotals=new Map([[A,0],[B,0]]); return [...items].sort((a,b)=>(b.weight||0)-(a.weight||0)).map(it=>{ let pick=A, min=1e9; [A,B].forEach(p=>{ const sc=(totals.get(p)||0)+(weekTotals.get(p)||0); if(sc<min){min=sc;pick=p;} }); weekTotals.set(pick,(weekTotals.get(p)||0)+(it.weight||0)); return { ...it, owner: pick }; }); }
    const mt=getMonthTotals(people); const weekTotals=new Map(); people.forEach(p=>weekTotals.set(p,0)); return [...items].sort((a,b)=>(b.weight||0)-(a.weight||0)).map(it=>{ let pick=people[0], min=1e9; for(const p of people){ const sc=(mt.get(p)||0)+(weekTotals.get(p)||0); if(sc<min){min=sc;pick=p;} } weekTotals.set(pick,(weekTotals.get(p)||0)+(it.weight||0)); return { ...it, owner: pick }; });
  }

  // ==== Render ====
  function renderAll(){ ensureMonthState(); const m=monthKey(); monthPill.textContent='Month: '+m; const pool=remainingPool(); const usedCount=chores.length-pool.length; const usedW=chores.reduce((s,t)=>s+((state[m].used||[]).indexOf(t.id)>-1?(t.weight||0):0),0); const totalW=chores.reduce((s,t)=>s+(t.weight||0),0); const pct=totalW?Math.round((usedW/totalW)*100):0; progressBar.style.width=pct+'%'; const people=readPeople(); const mt=getMonthTotals(people); const vals=people.map(p=>mt.get(p)||0); const delta=vals.length>1? (Math.max.apply(null,vals)-Math.min.apply(null,vals)).toFixed(1) : '0.0'; monthStats.textContent=usedCount+'/'+chores.length+' tasks • '+usedW.toFixed(1)+'/'+totalW.toFixed(1)+' weight ('+pct+'%)'+(people.length? ' • '+people.map(p=>p+' '+(mt.get(p)||0).toFixed(1)).join(' • ')+' (Δ '+delta+')':'' ); lastDrawEl.innerHTML=''; const last=(state[m].history[state[m].history.length-1]||null); lastDrawMeta.textContent=last? (last.items.length+' tasks • weight '+last.total.toFixed(1)) : '—'; (last? last.items: []).forEach(t=> lastDrawEl.appendChild(taskCard(t,true)) ); remainingEl.innerHTML=''; pool.sort((a,b)=>b.weight-a.weight).forEach(t=> remainingEl.appendChild(taskCard(t,false))); const remW=pool.reduce((s,t)=>s+(t.weight||0),0); remainingMeta.textContent=pool.length+' tasks • total weight '+remW.toFixed(1); renderTable(); }
  function taskCard(t,showOwner){ const d=document.createElement('div'); d.className='task-card'; d.innerHTML='<h3 class="task-title">'+escapeHtml(t.name)+'</h3><div class="muted">Weight <b>'+(t.weight||0).toFixed(1)+'</b>'+(showOwner&&t.owner? ' • <span class="owner-badge">'+escapeHtml(t.owner)+'</span>' : '')+'</div><div class="badges">'+(t.tags||[]).map(tag=>'<span class="pill">'+escapeHtml(tag)+'</span>').join('')+'</div>'; return d; }
  function renderTable(){ tableBody.innerHTML=''; chores.forEach((c,i)=>{ const tr=document.createElement('tr'); tr.innerHTML='<td><input type="text" value="'+escapeHtml(c.name)+'" data-k="name" data-i="'+i+'"></td><td><input type="number" step="0.5" value="'+c.weight+'" data-k="weight" data-i="'+i+'"></td><td><input type="text" value="'+(c.tags||[]).join(', ')+'" data-k="tags" data-i="'+i+'"></td><td><button class="btn secondary" data-del="'+i+'">Delete</button></td>'; tableBody.appendChild(tr); }); tableBody.querySelectorAll('input').forEach(inp=>{ inp.addEventListener('change',e=>{ const i=parseInt(e.target.dataset.i,10); const k=e.target.dataset.k; const v=e.target.value; if(k==='weight'){ chores[i][k]=Math.max(0.5, parseFloat(v)||1); } else if(k==='tags'){ chores[i][k]=v.split(',').map(x=>x.trim()).filter(Boolean); } else { chores[i][k]=v; chores[i].id=slug(chores[i].name); } save(LS_DATA,chores); renderAll(); }); }); tableBody.querySelectorAll('button[data-del]').forEach(btn=>{ btn.addEventListener('click',e=>{ const i=parseInt(e.target.dataset.del,10); if(confirm('Delete "'+chores[i].name+'"?')){ const id=chores[i].id; chores.splice(i,1); const m=monthKey(); state[m].used=(state[m].used||[]).filter(x=>x!==id); save(LS_DATA,chores); save(LS_STATE,state); renderAll(); } }); }); }

  // ==== Animations ====
  function animateDraw(items){ return new Promise(async resolve=>{ const overlay=document.getElementById('drawOverlay'); const list=document.getElementById('drawList'); const meta=document.getElementById('drawMeta'); const skipBtn=document.getElementById('skipDraw'); const drawBtn=document.getElementById('drawBtn'); meta.textContent=items.length+' task'+(items.length!==1?'s':'')+' • cap '+getCap(); list.innerHTML=''; overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); if(drawBtn) drawBtn.disabled=true; let skipped=false; const onSkip=()=>{skipped=true}; skipBtn.addEventListener('click',onSkip,{once:true}); const names=remainingPool().map(c=>c.name); if(!names.length) defaultChores.forEach(c=>names.push(c.name)); const people=readPeople(); for(let i=0;i<items.length;i++){ const card=document.createElement('div'); card.className='draw-item'; const roller=document.createElement('div'); roller.className='roller'; roller.textContent='Rolling…'; const note=document.createElement('div'); note.className='muted'; note.textContent='Picking next chore'; card.appendChild(roller); card.appendChild(note); list.appendChild(card); list.scrollTop=list.scrollHeight; if(!skipped){ const tick=75; const dur=1600+Math.random()*900; const int=setInterval(()=>{ const r=Math.floor(Math.random()*names.length); roller.textContent=names[r]||'…'; },tick); await sleep(dur); clearInterval(int); } roller.classList.add('final'); roller.textContent=items[i].name; note.textContent='Weight '+(items[i].weight||0).toFixed(1); card.style.animation='pop .45s ease'; burstConfetti(card,18); if(!skipped){ await sleep(450); } const ownerLine=document.createElement('div'); ownerLine.className='owner-line'; const ownerRoll=document.createElement('div'); ownerRoll.className='roller'; ownerRoll.textContent='Assigning…'; ownerLine.appendChild(ownerRoll); card.appendChild(ownerLine); list.scrollTop=list.scrollHeight; if(people.length&&!skipped){ const oTick=100; const oDur=900+Math.random()*600; const oi=setInterval(()=>{ const rr=Math.floor(Math.random()*people.length); ownerRoll.textContent=people[rr]||'…'; },oTick); await sleep(oDur); clearInterval(oi);} ownerRoll.classList.add('final'); ownerRoll.textContent=items[i].owner||'—'; burstConfetti(card,12); if(skipped){ for(let j=i+1;j<items.length;j++){ const c2=document.createElement('div'); c2.className='draw-item'; const r2=document.createElement('div'); r2.className='roller final'; r2.textContent=items[j].name; const n2=document.createElement('div'); n2.className='muted'; n2.textContent='Weight '+(items[j].weight||0).toFixed(1); const oLine=document.createElement('div'); oLine.className='owner-line'; const oVal=document.createElement('span'); oVal.className='owner-badge'; oVal.textContent=items[j].owner||'—'; oLine.appendChild(oVal); c2.appendChild(r2); c2.appendChild(n2); c2.appendChild(oLine); list.appendChild(c2);} break; } } await sleep(350); overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); if(drawBtn) drawBtn.disabled=false; resolve(); }); }
  function burstConfetti(target,count){ const n=count||24; for(let i=0;i<n;i++){ const p=document.createElement('i'); p.className='confetti'; const hue=Math.floor(Math.random()*360); p.style.background='hsl('+hue+' 80% 60%)'; const dx=(Math.random()*220)-110; p.style.setProperty('--dx',dx.toFixed(1)+'px'); p.style.left=(50+(Math.random()*20-10))+'%'; p.style.animationDuration=(1.2+Math.random()*0.8)+'s'; target.appendChild(p); setTimeout(function(){ p.remove(); },2200);} }
  const sleep=function(ms){ return new Promise(function(r){ setTimeout(r,ms); }); };

  // ==== Storage & utils ====
  function load(k){ try{ return JSON.parse(localStorage.getItem(k)); } catch(e){ return null; } }
  function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function slug(s){ s=String(s).toLowerCase(); var out=''; var lastDash=false; for(var i=0;i<s.length;i++){ var c=s[i]; var ok=(c>='a'&&c<='z')||(c>='0'&&c<='9'); if(ok){ out+=c; lastDash=false; } else if(!lastDash){ out+='-'; lastDash=true; } } while(out.length&&out[0]==='-') out=out.slice(1); while(out.length&&out[out.length-1]==='-') out=out.slice(0,-1); return out; }
  function escapeHtml(s){ s=String(s).replace(/[&<>"']/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[c];}); return s; }

  function addChore(){ const name=($('#newName').value||'').trim(); const weight=parseFloat($('#newWeight').value||''); const tags=$('#newTags').value.split(',').map(function(t){return t.trim();}).filter(function(x){return x;}); if(!name||isNaN(weight)||weight<=0){ alert('Enter a name and positive weight.'); return; } const id=slug(name); chores.push({id:id,name:name,weight:Math.max(0.5,weight),tags:tags}); save(LS_DATA,chores); $('#newName').value=''; $('#newWeight').value=''; $('#newTags').value=''; renderAll(); }

  // ==== Minimal self-tests (console only) ====
  (function runSelfTests(){
    const results=[]; const log=(n,p)=>{(p?console.log:console.warn)('[Test]',n,p?'✓':'✗')};
    function assert(n,cond){ results.push({n,pass:!!cond}); log(n,!!cond); }
    // T1: export function exists
    assert('exportJSON defined', typeof exportJSON==='function');
    // T2: import function exists
    assert('importJSON defined', typeof importJSON==='function');
    // T3: optimizer respects cap
    (function(){ const pool=[{id:'a',weight:2},{id:'b',weight:2},{id:'c',weight:2}]; const picked=optimizeWeeklySubset2(pool,4,['A','B']); const sum=picked.reduce((s,t)=>s+(t.weight||0),0); assert('opt subset <= cap', sum<=4+1e-9); })();
    // T4: fairAssign can meet ±0.5 when trivial
    (function(){ const items=[{id:'x',weight:2},{id:'y',weight:2}]; const out=fairAssign(items,['A','B']); const a=out.filter(o=>o.owner==='A').reduce((s,t)=>s+t.weight,0); const b=out.filter(o=>o.owner==='B').reduce((s,t)=>s+t.weight,0); assert('weekly diff <= 0.5 in simple case', Math.abs(a-b)<=0.5+1e-9); })();
    // T5: export payload shape
    (function(){ const payload={version:1,chores:[{id:'t',name:'Test',weight:1}]}; const round=JSON.parse(JSON.stringify(payload)); assert('export payload has chores[]', Array.isArray(round.chores)&&round.chores.length===1); })();
    const passed=results.filter(r=>r.pass).length; console.log(`[Self-tests] ${passed}/${results.length} passed`);
  })();

})();
</script>
</body></html>
