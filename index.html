<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weighted Weekly Chore Picker</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg: #0b0c10;        /* auto-swapped via color-scheme */
    --text: #111827;
    --muted: #6b7280;
    --card: #ffffff;
    --accent: #2563eb;
    --accent-2: #10b981;
    --border: #e5e7eb;
    color-scheme: light dark;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg: #0b0c10;
      --text: #f3f4f6;
      --muted: #9ca3af;
      --card: #111827;
      --accent: #60a5fa;
      --accent-2: #34d399;
      --border: #1f2937;
    }
  }
  *{ box-sizing: border-box; }
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background: var(--bg); color: var(--text);
  }
  .container{ max-width:1100px; margin:0 auto; padding:24px; }
  header{ display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px; }
  h1{ font-size:clamp(20px, 4vw, 28px); margin:0; letter-spacing:.2px; }
  .sub{ color:var(--muted); font-size:14px; }
  .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:end; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.05); }
  .controls{ display:flex; flex-wrap:wrap; gap:12px; align-items:end; }
  label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
  input[type=number], input[type=text]{ background:transparent; color:var(--text); border:1px solid var(--border); padding:10px 12px; border-radius:10px; min-width:140px; }
  input[type=text]{ min-width:220px; }
  .btn{ appearance:none; border:1px solid var(--border); background:var(--text); color:var(--bg); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; transition:.2s transform, .2s opacity; }
  .btn:hover{ transform: translateY(-1px); }
  .btn.secondary{ background:transparent; color:var(--text); }
  .btn.ghost{ background:transparent; border-color:transparent; color:var(--muted); }
  .btn.accent{ background:var(--accent); color:white; border-color:transparent; }
  .btn.success{ background:var(--accent-2); color:#06261b; border-color:transparent; }
  .pill{ display:inline-flex; align-items:center; gap:6px; font-size:12px; color:var(--muted); background:transparent; border:1px solid var(--border); padding:4px 10px; border-radius:999px; }
  .grid{ display:grid; grid-template-columns: repeat( auto-fit, minmax(240px, 1fr) ); gap:12px; }
  .task-card{ position:relative; overflow:hidden; }
  .task-title{ font-weight:700; margin:0 0 6px; font-size:16px; }
  .muted{ color:var(--muted); font-size:12px; }
  .badges{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
  .section-title{ display:flex; align-items:center; justify-content:space-between; margin:16px 0 8px; }
  .progress{ height:10px; width:100%; background:transparent; border:1px solid var(--border); border-radius:999px; overflow:hidden; }
  .progress > span{ display:block; height:100%; background:linear-gradient(90deg, var(--accent), var(--accent-2)); width:0%; transition: width .4s ease; }
  .split{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media (max-width: 820px){ .split{ grid-template-columns:1fr; } }
  .stack{ display:flex; flex-direction:column; gap:12px; }
  .history{ display:flex; flex-direction:column; gap:8px; }
  .history-item{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px dashed var(--border); border-radius:12px; }
  .tag{ font-size:11px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted); }
  .owner{ font-size:12px; padding:4px 8px; border-radius:8px; background: rgba(37,99,235,.12); color: var(--accent); font-weight:700; }
  .owners{ display:flex; gap:8px; }
  .inline{ display:inline-flex; gap:6px; align-items:center; }
  .table{ width:100%; border-collapse: collapse; }
  .table th, .table td{ padding:10px 8px; border-bottom:1px solid var(--border); text-align:left; font-size:14px; }
  .table input{ width:100%; }
  .chip{ font-size:12px; padding:4px 8px; border-radius:999px; background: rgba(16,185,129,.12); color:#10b981; font-weight:700; }
  .warn{ color:#f59e0b; }
  .danger{ color:#ef4444; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Weighted Weekly Chore Picker</h1>
        <div class="sub">Auto-resets monthly • No repeats within month • Weighted draw to a weekly cap</div>
      </div>
      <div class="pill" id="monthPill">Month: —</div>
    </header>

    <section class="card">
      <div class="controls">
        <div>
          <label for="cap">Weekly weight cap</label>
          <input id="cap" type="number" step="0.5" min="0.5" value="8" />
        </div>
        <div>
          <label>People (comma separated)</label>
          <input id="people" type="text" placeholder="Adam, Partner" value="Adam, Partner" />
        </div>
        <button class="btn accent" id="drawBtn">Draw this week</button>
        <button class="btn success" id="finishBtn" title="Pick all remaining items for this month (may exceed cap)">Finish month</button>
        <button class="btn secondary" id="undoBtn" title="Remove last draw and return items to pool">Undo last week</button>
        <button class="btn ghost" id="resetBtn" title="Start a fresh month now">Reset month</button>
      </div>

      <div class="split" style="margin-top:16px;">
        <div class="stack">
          <div class="section-title"><strong>This month</strong> <span class="muted" id="monthStats">—</span></div>
          <div class="progress"><span id="progressBar"></span></div>
          <div class="history" id="history"></div>
        </div>
        <div class="stack">
          <div class="section-title"><strong>Last draw</strong> <span class="muted" id="lastDrawMeta">—</span></div>
          <div class="grid" id="lastDraw"></div>
        </div>
      </div>
    </section>

    <section class="section-title" style="margin-top:16px;">
      <strong>Remaining tasks this month</strong>
      <span class="muted" id="remainingMeta">—</span>
    </section>
    <div class="grid" id="remaining"></div>

    <section class="section-title" style="margin-top:20px;">
      <strong>Manage chores</strong>
      <span class="muted">Add/edit weights, tags. Changes persist locally.</span>
    </section>
    <div class="card">
      <div class="row">
        <input id="newName" type="text" placeholder="Chore name" />
        <input id="newWeight" type="number" step="0.5" placeholder="Weight" />
        <input id="newTags" type="text" placeholder="Tags (comma separated)" />
        <button class="btn" id="addBtn">Add chore</button>
        <button class="btn secondary" id="exportBtn">Export JSON</button>
        <input type="file" id="importInput" accept="application/json" style="display:none" />
        <button class="btn secondary" id="importBtn">Import JSON</button>
      </div>
      <div style="overflow:auto; margin-top:12px;">
        <table class="table" id="table">
          <thead>
            <tr><th>Name</th><th style="width:120px">Weight</th><th>Tags</th><th style="width:80px"></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <footer style="margin:18px 0;" class="muted">
      Tip: Set a sensible weekly cap (e.g., 8–12). Use <span class="chip">Finish month</span> to clear any leftovers in the final week.
    </footer>
  </div>

<script>
(function(){
  const monthKey = () => new Date().toISOString().slice(0,7); // YYYY-MM
  const LS_DATA = 'choresDeck_v1_data';
  const LS_STATE = 'choresDeck_v1_state';

  /** Default chores — seeded from your list, plus a few helpful adds */
  const defaultChores = [
    {id:'cleaning_shared_bathroom', name:'Cleaning Shared Bathroom', weight:3, tags:['Bathroom']},
    {id:'cleaning_bedroom_bathroom', name:'Cleaning Bedroom Bathroom', weight:3, tags:['Bathroom']},
    {id:'cleaning_base_floor_bathroom', name:'Cleaning Base Floor Bathroom', weight:3, tags:['Bathroom']},
    {id:'sweeping_main_level_floor', name:'Sweeping the main level floor', weight:1, tags:['Floors']},
    {id:'sweeping_second_level_floor', name:'Sweeping the second level floor', weight:1, tags:['Floors']},
    {id:'mopping_main_level_floor', name:'Mopping the main level floor', weight:2, tags:['Floors']},
    {id:'mopping_second_level_floor', name:'Mopping the second level floor', weight:2, tags:['Floors']},
    {id:'metsi_nails', name:'Metsi Nails', weight:1, tags:['Pet']},
    {id:'metsi_bath', name:'Metsi Bath', weight:1.5, tags:['Pet']},
    {id:'inspecting_the_attic', name:'Inspecting the attic', weight:2.5, tags:['Home Care']},
    {id:'weeding', name:'Weeding', weight:2, tags:['Outdoor']},
    {id:'lawn_mowing_weed_wacking', name:'Lawn Mowing/Weed Wacking', weight:3, tags:['Outdoor']},
    {id:'watering_the_plants', name:'Watering the plants', weight:1, tags:['Outdoor']},
    {id:'cleaning_organizing_the_fridge', name:'Cleaning/Organizing the Fridge', weight:2, tags:['Kitchen']},
    {id:'dusting_the_main_floor', name:'Dusting the main floor', weight:1.5, tags:['Dusting']},
    {id:'dusting_the_second_floor', name:'Dusting the second floor', weight:1.5, tags:['Dusting']},
    {id:'wiping_down_windows_main_floor', name:'Wiping Down Windows main floor', weight:2, tags:['Windows']},
    {id:'wiping_down_windows_second_floor', name:'Wiping Down Windows second floor', weight:2, tags:['Windows']},
    {id:'tidying_main_floor', name:'General Item Cleanup/Tidying Main Floor', weight:1, tags:['Tidy']},
    {id:'tidying_second_floor', name:'General Item Cleanup/Tidying Second Floor', weight:1, tags:['Tidy']},
    {id:'wiping_down_walls', name:'Wiping Down Walls', weight:2, tags:['Surfaces']},
    {id:'vacuuming_stairs_living_room', name:'Vacuuming Stairs/Living Room', weight:2, tags:['Floors']},
    {id:'vaccuuming_upstairs', name:'Vaccuuming Upstairs', weight:1.5, tags:['Floors']},
  ];

  // --- State ---
  let chores = load(LS_DATA) || defaultChores;
  let state = load(LS_STATE) || {};
  ensureMonthState();

  // Elements
  const el = s => document.querySelector(s);
  const capInput = el('#cap');
  const peopleInput = el('#people');
  const monthPill = el('#monthPill');
  const monthStats = el('#monthStats');
  const progressBar = el('#progressBar');
  const historyEl = el('#history');
  const lastDrawEl = el('#lastDraw');
  const lastDrawMeta = el('#lastDrawMeta');
  const remainingEl = el('#remaining');
  const remainingMeta = el('#remainingMeta');

  // Manage table
  const tableBody = el('#table tbody');
  const addBtn = el('#addBtn');
  const newName = el('#newName');
  const newWeight = el('#newWeight');
  const newTags = el('#newTags');

  // Buttons
  el('#drawBtn').addEventListener('click', onDrawWeek);
  el('#finishBtn').addEventListener('click', () => acceptDraw(remainingPool(), true));
  el('#undoBtn').addEventListener('click', undoLastWeek);
  el('#resetBtn').addEventListener('click', resetMonthConfirm);

  // Import/Export
  el('#exportBtn').addEventListener('click', exportJSON);
  el('#importBtn').addEventListener('click', () => el('#importInput').click());
  el('#importInput').addEventListener('change', importJSON);

  addBtn.addEventListener('click', () => {
    const name = (newName.value||'').trim();
    const weight = parseFloat(newWeight.value||'');
    const tags = (newTags.value||'').split(',').map(t=>t.trim()).filter(Boolean);
    if(!name || isNaN(weight) || weight<=0){ alert('Enter a name and positive weight.'); return; }
    const id = slug(name);
    chores.push({id,name,weight,tags});
    save(LS_DATA, chores);
    newName.value = newWeight.value = newTags.value = '';
    renderAll();
  });

  // Initial
  capInput.value = state.cap ?? 8;
  peopleInput.value = (state.people && state.people.length) ? state.people.join(', ') : 'Adam, Partner';
  renderAll();

  // --- Functions ---
  function onDrawWeek(){
    const cap = getCap();
    const pool = remainingPool();
    if(pool.length===0){ alert('No remaining tasks this month. Use Reset month to start a new month.'); return; }
    const picked = drawToCap(pool, cap);
    if(picked.length===0){
      // Edge case: all tasks heavier than cap
      const lightest = [...pool].sort((a,b)=>a.weight-b.weight)[0];
      if(lightest) picked.push(lightest);
    }
    acceptDraw(picked, false);
  }

  function acceptDraw(items, isFinish){
    const month = monthKey();
    const people = readPeople();
    const assigned = fairAssign(items, people);
    const total = items.reduce((s,t)=>s+(t.weight||0),0);

    state[month].history.push({
      ts: Date.now(),
      items: assigned,
      total,
      finish: !!isFinish
    });
    const usedSet = new Set(state[month].used);
    items.forEach(i=> usedSet.add(i.id));
    state[month].used = Array.from(usedSet);
    state.cap = getCap();
    state.people = people;
    save(LS_STATE, state);
    renderAll();
  }

  function undoLastWeek(){
    const month = monthKey();
    const hist = state[month].history;
    if(hist.length===0){ alert('Nothing to undo.'); return; }
    const last = hist.pop();
    // remove used items from used[], but only those in last draw
    const ids = new Set(last.items.map(x=>x.id));
    state[month].used = state[month].used.filter(id => !ids.has(id));
    save(LS_STATE, state);
    renderAll();
  }

  function resetMonthConfirm(){
    if(confirm('Start a fresh month now? This clears this month\'s draws.')){
      const m = monthKey();
      state[m] = { used: [], history: [] };
      save(LS_STATE, state);
      renderAll();
    }
  }

  function ensureMonthState(){
    const m = monthKey();
    if(!state[m]) state[m] = { used: [], history: [] };
    // Clean up stray months far in the past to keep LS small (keep last 6 months)
    const months = Object.keys(state).filter(k=>/\d{4}-\d{2}/.test(k));
    months.sort();
    while(months.length>6){ const old = months.shift(); delete state[old]; }
    save(LS_STATE, state);
  }

  function remainingPool(){
    const m = monthKey();
    const used = new Set(state[m].used);
    return chores.filter(c=>!used.has(c.id));
  }

  function getCap(){ return Math.max(0.5, parseFloat(capInput.value)||8); }
  function readPeople(){ return peopleInput.value.split(',').map(s=>s.trim()).filter(Boolean); }

  function drawToCap(pool, cap){
    const remaining = pool.slice();
    const picked = [];
    let total = 0;
    // Avoid infinite loops by limiting iterations
    let guard = 1000;
    while(guard-- && remaining.length){
      const feasible = remaining.filter(t => (total + (t.weight||0)) <= cap);
      if(feasible.length===0) break;
      const chosen = weightedPick(feasible);
      picked.push(chosen);
      total += (chosen.weight||0);
      const idx = remaining.findIndex(x=>x.id===chosen.id);
      if(idx>-1) remaining.splice(idx,1);
    }
    return picked;
  }

  function weightedPick(list){
    const total = list.reduce((s,t)=> s + (t.weight||1), 0);
    let r = Math.random()*total;
    for(const item of list){
      r -= (item.weight||1);
      if(r <= 0) return item;
    }
    return list[list.length-1];
  }

  function autoAssign(items, people){
    if(!people.length){ return items.map(i=>({...i, owner: undefined})); }
    const totals = new Map(people.map(p=>[p,0]));
    const sorted = [...items].sort((a,b)=>(b.weight||0)-(a.weight||0));
    return sorted.map(it=>{
      // pick person with lowest current total
      let pick = people[0];
      let min = Infinity;
      for(const p of people){
        const v = totals.get(p)||0; if(v < min){ min=v; pick=p; }
      }
      totals.set(pick, (totals.get(pick)||0) + (it.weight||0));
      return {...it, owner: pick};
    });
  }

  function getMonthTotals(people){
    const m = monthKey();
    const totals = new Map(people.map(p=>[p,0]));
    for(const h of state[m].history){
      for(const it of h.items){
        if(it.owner && totals.has(it.owner)){
          totals.set(it.owner, (totals.get(it.owner)||0) + (it.weight||0));
        }
      }
    }
    return totals;
  }

  function fairAssign(items, people){
    if(!people.length){ return items.map(i=>({...i, owner: undefined})); }
    if(people.length===1){ return items.map(i=>({...i, owner: people[0]})); }

    // Two people: compute an optimal split for the week that also equalizes month-to-date totals
    if(people.length===2){
      const [A,B] = people;
      const monthTotals = getMonthTotals(people);
      const mA = monthTotals.get(A)||0, mB = monthTotals.get(B)||0;
      const delta = mA - mB; // positive => A has more so far
      const weights = items.map(i=> i.weight||0);
      const weekSum = weights.reduce((s,w)=>s+w,0);
      const targetForA = (weekSum - delta)/2; // choose subset for A near this target

      const n = items.length;
      if(n <= 22){
        let bestMask = 0, bestDiff = Infinity, bestSecondary = Infinity;
        const maxMask = 1 << n;
        for(let mask=0; mask<maxMask; mask++){
          let s = 0;
          for(let i=0;i<n;i++){ if(mask & (1<<i)) s += weights[i]; }
          const diff = Math.abs(targetForA - s);
          if(diff < bestDiff){
            bestDiff = diff; bestMask = mask;
            bestSecondary = Math.abs((mA + s) - (mB + (weekSum - s)));
          } else if(diff === bestDiff){
            const sec = Math.abs((mA + s) - (mB + (weekSum - s)));
            if(sec < bestSecondary){ bestSecondary = sec; bestMask = mask; }
          }
        }
        return items.map((it,i)=> ({...it, owner: (bestMask & (1<<i)) ? A : B}));
      }
      // Fallback greedy for unusually large weekly sets
      const totals = new Map([[A,mA],[B,mB]]);
      const weekTotals = new Map([[A,0],[B,0]]);
      return [...items].sort((a,b)=>(b.weight||0)-(a.weight||0)).map(it=>{
        let pick=A; let min=Infinity;
        for(const p of [A,B]){
          const score = (totals.get(p)||0) + (weekTotals.get(p)||0);
          if(score < min){ min=score; pick=p; }
        }
        weekTotals.set(pick, (weekTotals.get(pick)||0) + (it.weight||0));
        return {...it, owner: pick};
      });
    }

    // 3+ people: greedy using month-to-date + this week totals
    const monthTotals = getMonthTotals(people);
    const weekTotals = new Map(people.map(p=>[p,0]));
    return [...items].sort((a,b)=>(b.weight||0)-(a.weight||0)).map(it=>{
      let pick = people[0], min = Infinity;
      for(const p of people){
        const score = (monthTotals.get(p)||0) + (weekTotals.get(p)||0);
        if(score < min){ min = score; pick = p; }
      }
      weekTotals.set(pick, (weekTotals.get(p)||0) + (it.weight||0));
      return {...it, owner: pick};
    });
  }

  function renderAll(){
    ensureMonthState();
    const m = monthKey();
    monthPill.textContent = `Month: ${m}`;

    // stats
    const pool = remainingPool();
    const usedCount = chores.length - pool.length;
    const usedWeight = chores.reduce((s,t)=> s + (state[m].used.includes(t.id) ? (t.weight||0) : 0), 0);
    const totalWeight = chores.reduce((s,t)=> s + (t.weight||0), 0);
    const pct = totalWeight? Math.round((usedWeight/totalWeight)*100) : 0;
    progressBar.style.width = pct + '%';
    const peopleList = readPeople();
    const mtot = getMonthTotals(peopleList);
    const vals = peopleList.map(p => mtot.get(p)||0);
    const fairness = peopleList.length ? ' • ' + peopleList.map(p => `${p} ${(mtot.get(p)||0).toFixed(1)}`).join(' • ') + (peopleList.length>1 ? ` (Δ ${(Math.max(...vals)-Math.min(...vals)).toFixed(1)})` : '') : '';
    monthStats.textContent = `${usedCount}/${chores.length} tasks • ${usedWeight.toFixed(1)}/${totalWeight.toFixed(1)} weight (${pct}%)${fairness}`;

    // history list
    historyEl.innerHTML = '';
    state[m].history.slice().reverse().forEach((h,i)=>{
      const when = new Date(h.ts).toLocaleString([], {month:'short', day:'numeric'});
      const div = document.createElement('div');
      div.className = 'history-item';
      const names = h.items.map(x=>x.name).join(', ');
      div.innerHTML = `<div><strong>${when}</strong> • ${h.items.length} tasks • weight ${h.total.toFixed(1)} ${h.finish?'<span class="chip">Finished</span>':''}<div class="muted" style="margin-top:4px; max-width:720px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${names}</div></div>`;
      historyEl.appendChild(div);
    });

    // last draw cards
    lastDrawEl.innerHTML = '';
    const last = state[m].history[state[m].history.length-1];
    lastDrawMeta.textContent = last ? `${last.items.length} tasks • weight ${last.total.toFixed(1)}` : '—';
    (last?.items||[]).forEach(t=>{
      lastDrawEl.appendChild(taskCard(t, true));
    });

    // remaining
    remainingEl.innerHTML = '';
    pool.sort((a,b)=> b.weight - a.weight).forEach(t=> remainingEl.appendChild(taskCard(t,false)) );
    remainingMeta.textContent = `${pool.length} tasks • total weight ${pool.reduce((s,t)=>s+(t.weight||0),0).toFixed(1)}`;

    // table
    renderTable();
  }

  function taskCard(t, showOwner){
    const div = document.createElement('div');
    div.className = 'card task-card';
    div.innerHTML = `
      <h3 class="task-title">${escapeHtml(t.name)}</h3>
      <div class="inline"><span class="pill" title="Weight">Weight: <strong>${(t.weight||0).toFixed(1)}</strong></span>
      ${showOwner && t.owner ? `<span class="owner" title="Assigned to">${escapeHtml(t.owner)}</span>`:''}</div>
      <div class="badges">${(t.tags||[]).map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}</div>
    `;
    return div;
  }

  function renderTable(){
    tableBody.innerHTML = '';
    chores.forEach((c, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" value="${escapeHtml(c.name)}" data-k="name" data-i="${idx}" /></td>
        <td><input type="number" step="0.5" value="${c.weight}" data-k="weight" data-i="${idx}" /></td>
        <td><input type="text" value="${(c.tags||[]).join(', ')}" data-k="tags" data-i="${idx}" /></td>
        <td><button class="btn secondary" data-del="${idx}">Delete</button></td>
      `;
      tableBody.appendChild(tr);
    });
    tableBody.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('change', e=>{
        const i = +e.target.dataset.i;
        const k = e.target.dataset.k;
        let v = e.target.value;
        if(k==='weight'){ chores[i][k] = Math.max(0.5, parseFloat(v)||1); }
        else if(k==='tags'){ chores[i][k] = v.split(',').map(x=>x.trim()).filter(Boolean); }
        else { chores[i][k] = v; chores[i].id = slug(chores[i].name); }
        save(LS_DATA, chores);
        renderAll();
      });
    });
    tableBody.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const i = +e.target.dataset.del;
        if(confirm(`Delete "${chores[i].name}"?`)){
          const id = chores[i].id;
          chores.splice(i,1);
          // Also remove from used if present
          const m = monthKey();
          state[m].used = state[m].used.filter(x=>x!==id);
          save(LS_DATA, chores); save(LS_STATE, state); renderAll();
        }
      });
    });
  }

  function exportJSON(){
    const data = { chores, state };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `chore-deck-${monthKey()}.json`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  function importJSON(evt){
    const file = evt.target.files?.[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(String(reader.result));
        if(parsed.chores && Array.isArray(parsed.chores)) chores = parsed.chores;
        if(parsed.state && typeof parsed.state==='object') state = parsed.state;
        save(LS_DATA, chores); save(LS_STATE, state); ensureMonthState(); renderAll();
      }catch(err){ alert('Invalid JSON'); }
    };
    reader.readAsText(file);
    // reset input so same file can be selected again later
    evt.target.value = '';
  }

  // --- Utils ---
  function load(key){ try{ return JSON.parse(localStorage.getItem(key)); }catch{ return null; } }
  function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
  function slug(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c])); }

})();
</script>
</body>
</html>
